<%
// load menu options and contacts from content
const menu = _.cms('menu') || {}
const contacts = _.cms('contacts') || {}
// some social networks handled by contacts
const networksWithColors = [
  ['facebook', '#3B5998'],
  ['youtube', '#FF0000'],
  ['instagram', '#E1306C'],
  ['twitter', '#1DA1F2']
]
// start grouping categories by parent slug
const allCategories = menu.alphabetical_order
  ? _.lodash.sortBy(_.categories, ['name'])
  : _.categories
const categoryParents = _.lodash.groupBy(allCategories, ({ parent }) => {
  return !parent || !parent.slug ? '_' : parent.slug
})
const getSubmenuId = slug => `a-${slug.replace(/\//g, '_')}`
const mainCategories = categoryParents._ || []

// helper para pegar categoria pelo slug
const bySlug = slug => mainCategories.find(cat => cat.slug === slug)
const catAprenda   = bySlug('aprenda-se-divertindo')
const catColecoes  = bySlug('colecoes')
const catParceiros = bySlug('parceiros')

// filhos / netos das 3 categorias especiais
const childrenAprenda   = catAprenda   ? (categoryParents[catAprenda.slug] || []) : []
const childrenColecoes  = catColecoes  ? (categoryParents[catColecoes.slug] || []) : []
const childrenParceiros = catParceiros ? (categoryParents[catParceiros.slug] || []) : []

const getGrandChildren = (cat) => categoryParents[cat.slug] || []
%>

<aside id="menu" class="menu shadow">
  <nav class="accordion" id="accordion-menu">
    <button
      class="menu__btn menu__btn--close btn"
      type="button"
      onclick="toggleSidenav()"
      aria-label="Toggle Side Navigation"
    >
      <i class="i-times"></i>
    </button>

    <div
      id="categories-nav"
      class="collapse show"
      aria-expanded="true"
      data-parent="#accordion-menu"
    >
      <div class="menu__list">
        <!-- mantém exatamente as categorias do topo -->
        <a href="/camiseta" class="menu__item">Camisetas</a>
        <a href="/camisetas-infantis" class="menu__item">Camisetas Infantis</a>

        <!-- Aprenda se Divertindo + filhos/netos -->
        <a href="/aprenda-se-divertindo" class="menu__item">Aprenda se Divertindo</a>
        <% childrenAprenda.forEach(child => { %>
          <a href="/<%= child.slug %>" class="menu__item menu__item--sub">
            <%= child.name %>
          </a>
          <% getGrandChildren(child).forEach(grand => { %>
            <a href="/<%= grand.slug %>" class="menu__item menu__item--sub2">
              <%= grand.name %>
            </a>
          <% }) %>
        <% }) %>

        <a href="/estampas" class="menu__item">Estampas</a>

        <!-- Coleções + filhos/netos -->
        <a href="/colecoes" class="menu__item">Coleções</a>
        <% childrenColecoes.forEach(child => { %>
          <a href="/<%= child.slug %>" class="menu__item menu__item--sub">
            <%= child.name %>
          </a>
          <% getGrandChildren(child).forEach(grand => { %>
            <a href="/<%= grand.slug %>" class="menu__item menu__item--sub2">
              <%= grand.name %>
            </a>
          <% }) %>
        <% }) %>

        <!-- Parceiros + filhos/netos -->
        <a href="/parceiros" class="menu__item">Parceiros</a>
        <% childrenParceiros.forEach(child => { %>
          <a href="/<%= child.slug %>" class="menu__item menu__item--sub">
            <%= child.name %>
          </a>
          <% getGrandChildren(child).forEach(grand => { %>
            <a href="/<%= grand.slug %>" class="menu__item menu__item--sub2">
              <%= grand.name %>
            </a>
          <% }) %>
        <% }) %>
      </div>
    </div>
  </nav>

  <footer class="menu__footer">
    <% if (menu.phone_wpp) { %>
      <div class="menu__phone">
        <% if (contacts.whatsapp) { %>
          <a
            href="javascript:;"
            target="_blank"
            rel="noopener"
            class="whatsapp-link"
            data-tel="<%= contacts.whatsapp.replace(/\D/g, '') %>"
          >
            <i class="i-whatsapp mr-1"></i>
            <%= contacts.whatsapp %>
          </a>
        <% } else if (contacts.phone) { %>
          <a
            href="tel:+<%= contacts.phone.replace(/\D/g, '') %>"
            target="_blank"
            rel="noopener"
          >
            <i class="i-phone mr-1"></i>
            <%= contacts.phone %>
          </a>
        <% } %>
      </div>
    <% } %>
    <% if (menu.socials) { %>
      <div class="menu__social">
        <% networksWithColors.forEach(([network, color]) => { %>
          <% if (contacts[network]) { %>
            <a
              href="<%= contacts[network] %>"
              target="_blank"
              rel="noopener"
              aria-label="<%= network %>"
              style="color: <%= color %>"
            >
              <i class="i-<%= network %>"></i>
            </a>
          <% } %>
        <% }) %>
      </div>
    <% } %>
  </footer>
</aside>
